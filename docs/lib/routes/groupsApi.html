<!DOCTYPE html>

<html>
<head>
  <title>groupsApi.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>groupsApi.js</h1>
        

        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="comment">/*
== BSD2 LICENSE ==
Copyright (c) 2014, Tidepool Project

This program is free software; you can redistribute it and/or modify it under
the terms of the associated License, which is identical to the BSD 2-Clause
License as published by the Open Source Initiative at opensource.org.

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE. See the License for more details.

You should have received a copy of the License along with this program; if
not, you can obtain one from Tidepool Project at tidepool.org.
== BSD2 LICENSE ==
 */</span>

<span class="string">'use strict'</span>;

<span class="keyword">var</span> log = require(<span class="string">'../log.js'</span>)(<span class="string">'groupsApi.js'</span>);

<span class="comment">/*
    Http interface for group-api
*/</span>
module.exports = <span class="function"><span class="keyword">function</span><span class="params">(crudHandler)</span> {</span>

    <span class="comment">/*
        HELPERS
    */</span></pre></div>
        
      
        
        <p>Does this group have all the fields we require?</p>

        
          <div class='highlight'><pre>    <span class="keyword">var</span> groupIsValid = <span class="function"><span class="keyword">function</span><span class="params">(group)</span>{</span>

        <span class="keyword">if</span> ((<span class="string">'members'</span> <span class="keyword">in</span> group &amp;&amp; group.members.length &gt; <span class="number">0</span>)) {

            <span class="keyword">return</span> <span class="literal">true</span>;
        } <span class="keyword">else</span> {
            log.warn(<span class="string">'group must have the fields [members], got[%j]'</span>,group);
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
    };

    <span class="comment">/*
        HEALTH CHECK 
    */</span>

    <span class="keyword">var</span> status =  <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> {</span>
        log.debug(<span class="string">'status: params[%j], url[%s], method[%s]'</span>, req.params, req.url, req.method);

        <span class="keyword">var</span> sessiontoken = req.headers[<span class="string">'x-tidepool-session-token'</span>];
        <span class="keyword">if</span> (sessiontoken) {

            

            <span class="keyword">if</span> (req.params.status) {
                res.send(parseInt(req.params.status));
            } <span class="keyword">else</span> {
                crudHandler.status(<span class="function"><span class="keyword">function</span><span class="params">(error,result)</span>{</span>
                    log.info(<span class="string">'returning status '</span> + result.statuscode);
                    res.send(result.statuscode, result.deps);
                });
            }
        }<span class="keyword">else</span> {
            log.warn(<span class="string">'Unauthorized request'</span>);
            res.send(<span class="number">401</span>)
        }
        <span class="keyword">return</span> next();
    };

    <span class="comment">/*
        WORK
    */</span>

    <span class="keyword">var</span> addGroup = <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> {</span>
     
        log.debug(<span class="string">'addGroup: params[%j], url[%s], method[%s]'</span>, req.params, req.url, req.method);

        <span class="keyword">var</span> sessiontoken = req.headers[<span class="string">'x-tidepool-session-token'</span>];
        <span class="keyword">if</span> (sessiontoken) {

            <span class="keyword">var</span> group = req.params.group;

            <span class="keyword">if</span> ( group &amp;&amp; groupIsValid(group)){

                crudHandler.createGroup(group, <span class="function"><span class="keyword">function</span><span class="params">(error,id)</span>{</span>
                    <span class="keyword">if</span> (error){
                        log.error(error, <span class="string">'Error saving group[%j]'</span>, group);
                        res.send(<span class="number">500</span>);
                    } <span class="keyword">else</span> {
                        res.send(<span class="number">201</span>,{id : id});
                    }
                });
            } <span class="keyword">else</span> {
                res.send(<span class="number">400</span>);
            }
        }<span class="keyword">else</span> {
            log.warn(<span class="string">'Unauthorized request'</span>);
            res.send(<span class="number">401</span>)
        }
        <span class="keyword">return</span> next();
    };

    <span class="keyword">var</span> memberOf = <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> {</span>
     
        log.debug(<span class="string">'memberOf: params[%j], url[%s], method[%s]'</span>, req.params, req.url, req.method);

        <span class="keyword">var</span> sessiontoken = req.headers[<span class="string">'x-tidepool-session-token'</span>];
        <span class="keyword">if</span> (sessiontoken) {

            <span class="keyword">var</span> userId = req.params.userid;

            <span class="keyword">if</span>(userId){
                crudHandler.findGroupsMemberOf(userId,<span class="function"><span class="keyword">function</span><span class="params">(error,groups)</span>{</span>
                    <span class="keyword">if</span> (error){
                        log.error(error, <span class="string">'Error getting groups user[%s] is a member of'</span>, userId);
                        res.send(<span class="number">500</span>);
                    } <span class="keyword">else</span> {
                        <span class="keyword">if</span> (groups.length&gt;<span class="number">0</span>){
                            res.send(<span class="number">200</span>,{groups : groups});
                        }<span class="keyword">else</span>{
                            res.send(<span class="number">204</span>);
                        }
                    }
                });
            } <span class="keyword">else</span> {
                res.send(<span class="number">400</span>);
            }
        }<span class="keyword">else</span> {
            log.warn(<span class="string">'Unauthorized request'</span>);
            res.send(<span class="number">401</span>)
        }

        <span class="keyword">return</span> next();
    };

    <span class="keyword">var</span> addToGroup = <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> {</span>
      
        log.debug(<span class="string">'addToGroup: params[%j], url[%s], method[%s]'</span>, req.params, req.url, req.method);

        <span class="keyword">var</span> sessiontoken = req.headers[<span class="string">'x-tidepool-session-token'</span>];
        <span class="keyword">if</span> (sessiontoken) {

            <span class="keyword">var</span> groupId = req.params.groupid;
            <span class="keyword">var</span> userId = req.params.userid;

            <span class="keyword">if</span>(groupId &amp;&amp; userId){
                crudHandler.addUserToGroup(groupId, userId, <span class="function"><span class="keyword">function</span><span class="params">(error,updatedGroup)</span>{</span>
                    <span class="keyword">if</span> (error){
                        log.error(error, <span class="string">'Error adding user[%s] to the group[%s]'</span>, userId, groupId);
                        res.send(<span class="number">500</span>);
                    } <span class="keyword">else</span> {
                        <span class="keyword">if</span> (updatedGroup &amp;&amp; groupIsValid(updatedGroup)){
                            res.send(<span class="number">200</span>,{group : updatedGroup});
                        }<span class="keyword">else</span>{
                            res.send(<span class="number">204</span>);
                        }
                    }
                });
            } <span class="keyword">else</span> {
                res.send(<span class="number">400</span>);
            }

        }<span class="keyword">else</span> {
            log.warn(<span class="string">'Unauthorized request'</span>);
            res.send(<span class="number">401</span>)
        }

        <span class="keyword">return</span> next();
    };

    <span class="keyword">var</span> removeFromGroup = <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> {</span>
      
        log.debug(<span class="string">'removeFromGroup: params[%j], url[%s], method[%s]'</span>, req.params, req.url, req.method);

        <span class="keyword">var</span> sessiontoken = req.headers[<span class="string">'x-tidepool-session-token'</span>];
        <span class="keyword">if</span> (sessiontoken) {

            <span class="keyword">var</span> groupId = req.params.groupid;
            <span class="keyword">var</span> userId = req.params.userid;


            <span class="keyword">if</span>(groupId &amp;&amp; userId){
                crudHandler.removeUserFromGroup(groupId, userId, <span class="function"><span class="keyword">function</span><span class="params">(error,updatedGroup)</span>{</span>
                    <span class="keyword">if</span> (error){
                        log.error(error, <span class="string">'Error removing user[%s] from group[%s]'</span>, userId, groupId);
                        res.send(<span class="number">500</span>);
                    } <span class="keyword">else</span> {
                        <span class="keyword">if</span> (updatedGroup &amp;&amp; groupIsValid(updatedGroup)){
                            res.send(<span class="number">200</span>,{group : updatedGroup});
                        }<span class="keyword">else</span>{
                            res.send(<span class="number">204</span>);
                        }
                    }
                });
            } <span class="keyword">else</span> {
                res.send(<span class="number">400</span>);
            }
        }<span class="keyword">else</span> {
            log.warn(<span class="string">'Unauthorized request'</span>);
            res.send(<span class="number">401</span>)
        }

        <span class="keyword">return</span> next();
    };

    <span class="keyword">var</span> getAllInGroup = <span class="function"><span class="keyword">function</span><span class="params">(req, res, next)</span> {</span>
      
        log.debug(<span class="string">'getAllInGroup: params[%j], url[%s], method[%s]'</span>, req.params, req.url, req.method);

        <span class="keyword">var</span> sessiontoken = req.headers[<span class="string">'x-tidepool-session-token'</span>];
        <span class="keyword">if</span> (sessiontoken) {

            res.send(<span class="number">501</span>);

        }<span class="keyword">else</span> {
            log.warn(<span class="string">'Unauthorized request'</span>);
            res.send(<span class="number">401</span>)
        }

        <span class="keyword">return</span> next();
    };

    <span class="keyword">return</span> {
        status : status,
        addGroup : addGroup,
        memberOf : memberOf,
        addToGroup : addToGroup,
        removeFromGroup : removeFromGroup,
        getAllInGroup : getAllInGroup
    };
};</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
